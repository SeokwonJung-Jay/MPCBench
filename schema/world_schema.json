{
  "required": ["world_id", "level", "timezone", "world_start", "world_end", "sources"],
  "properties": {
    "world_id": {
      "type": "string",
      "title": "World ID",
      "description": "Unique identifier for this world"
    },
    "level": {
      "type": "integer",
      "enum": [1, 2, 3],
      "title": "Difficulty Level",
      "description": "Difficulty level: 1 (easy), 2 (mid), 3 (hard)"
    },
    "timezone": {
      "type": "string",
      "title": "Timezone",
      "description": "IANA timezone identifier (e.g., 'Asia/Seoul')",
      "default": "Asia/Seoul"
    },
    "world_start": {
      "$ref": "#/$defs/datetime",
      "title": "World Start",
      "description": "Start datetime of the world time window"
    },
    "world_end": {
      "$ref": "#/$defs/datetime",
      "title": "World End",
      "description": "End datetime of the world time window"
    },
    "sources": {
      "type": "object",
      "title": "Data Sources",
      "description": "Data sources available for this world level",
      "properties": {
        "calendar_json": {
          "type": "object",
          "title": "Calendar Data",
          "description": "Mapping of person_id to array of busy events",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/$defs/busy_event"
            }
          }
        },
        "policy_json": {
          "type": "object",
          "title": "Policy Data (Level 1)",
          "description": "Machine-readable policy rules (level 1 only)",
          "additionalProperties": {
            "type": "object",
            "required": ["rules"],
            "properties": {
              "rules": {
                "type": "array",
                "items": {
                  "oneOf": [
                    { "$ref": "#/$defs/work_hours_rule" },
                    { "$ref": "#/$defs/lunch_block_rule" },
                    { "$ref": "#/$defs/buffer_min_rule" },
                    { "$ref": "#/$defs/ban_dow_time_rule" }
                  ]
                }
              }
            }
          },
          "propertyNames": {
            "enum": ["POLICY_1", "POLICY_2", "POLICY_3", "POLICY_4"]
          }
        },
        "policy_text": {
          "type": "object",
          "title": "Policy Text (Level 2/3)",
          "description": "Policy document with natural language text and machine-readable tags",
          "required": ["doc_id", "text", "tags"],
          "properties": {
            "doc_id": {
              "type": "string",
              "title": "Document ID"
            },
            "text": {
              "type": "string",
              "title": "Policy Text",
              "description": "Natural language policy text"
            },
            "tags": {
              "type": "object",
              "title": "Policy Tags",
              "description": "Machine-readable policy tags (work hours, lunch, buffer, ban days)",
              "additionalProperties": true
            }
          }
        },
        "comm_threads": {
          "type": "array",
          "title": "Communication Threads (Level 2/3)",
          "description": "Array of communication thread objects",
          "items": {
            "type": "object",
            "required": ["thread_id", "text", "tags"],
            "properties": {
              "thread_id": {
                "type": "string",
                "title": "Thread ID"
              },
              "text": {
                "type": "string",
                "title": "Thread Text",
                "description": "Natural language thread content"
              },
              "tags": {
                "type": "object",
                "title": "Thread Tags",
                "description": "Machine-readable tags (level 2: deadline/ban constraints; level 3: participants, duration, num_options, rank/tie-break, plus deadline/ban if present)",
                "additionalProperties": true
              }
            }
          }
        },
        "people_table": {
          "type": "array",
          "title": "People Directory (Level 3)",
          "description": "Mapping of person names to person IDs",
          "items": {
            "type": "object",
            "required": ["person_name", "person_id"],
            "properties": {
              "person_name": {
                "type": "string",
                "title": "Person Name"
              },
              "person_id": {
                "type": "string",
                "title": "Person ID"
              }
            }
          }
        },
        "rooms_table": {
          "type": "array",
          "title": "Rooms Table (Level 3)",
          "description": "Room metadata table",
          "items": {
            "type": "object",
            "required": ["room_id", "capacity"],
            "properties": {
              "room_id": {
                "type": "string",
                "title": "Room ID"
              },
              "capacity": {
                "type": "integer",
                "minimum": 1,
                "title": "Room Capacity"
              },
              "equipment": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "title": "Equipment",
                "description": "List of equipment available in the room"
              }
            }
          }
        },
        "room_availability_json": {
          "type": "object",
          "title": "Room Availability (Level 3)",
          "description": "Mapping of room_id to array of busy events",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/$defs/busy_event"
            }
          }
        }
      },
      "additionalProperties": false
    }
  },
  "oneOf": [
    {
      "properties": {
        "level": { "const": 1 }
      },
      "required": ["world_id", "level", "timezone", "world_start", "world_end", "sources"],
      "allOf": [
        {
          "properties": {
            "sources": {
              "required": ["calendar_json", "policy_json"],
              "not": {
                "anyOf": [
                  { "properties": { "policy_text": {} } },
                  { "properties": { "comm_threads": {} } },
                  { "properties": { "people_table": {} } },
                  { "properties": { "rooms_table": {} } },
                  { "properties": { "room_availability_json": {} } }
                ]
              }
            }
          }
        }
      ]
    },
    {
      "properties": {
        "level": { "const": 2 }
      },
      "required": ["world_id", "level", "timezone", "world_start", "world_end", "sources"],
      "allOf": [
        {
          "properties": {
            "sources": {
              "required": ["calendar_json", "policy_text", "comm_threads"],
              "not": {
                "anyOf": [
                  { "properties": { "policy_json": {} } },
                  { "properties": { "people_table": {} } },
                  { "properties": { "rooms_table": {} } },
                  { "properties": { "room_availability_json": {} } }
                ]
              }
            }
          }
        }
      ]
    },
    {
      "properties": {
        "level": { "const": 3 }
      },
      "required": ["world_id", "level", "timezone", "world_start", "world_end", "sources"],
      "allOf": [
        {
          "properties": {
            "sources": {
              "required": ["calendar_json", "policy_text", "comm_threads", "people_table", "rooms_table", "room_availability_json"],
              "not": {
                "properties": { "policy_json": {} }
              }
            }
          }
        }
      ]
    }
  ],
  "$defs": {
    "datetime": {
      "type": "string",
      "format": "date-time",
      "title": "ISO-8601 DateTime",
      "description": "ISO-8601 datetime string (e.g., '2026-01-19T13:00:00')"
    },
    "busy_event": {
      "type": "object",
      "required": ["start", "end"],
      "properties": {
        "start": {
          "$ref": "#/$defs/datetime",
          "title": "Event Start"
        },
        "end": {
          "$ref": "#/$defs/datetime",
          "title": "Event End"
        },
        "title": {
          "type": "string",
          "title": "Event Title",
          "description": "Optional event title"
        }
      },
      "additionalProperties": false
    },
    "work_hours_rule": {
      "type": "object",
      "required": ["type", "start", "end"],
      "properties": {
        "type": { "const": "work_hours" },
        "start": { "type": "string" },
        "end": { "type": "string" }
      },
      "additionalProperties": false
    },
    "lunch_block_rule": {
      "type": "object",
      "required": ["type", "start", "end"],
      "properties": {
        "type": { "const": "lunch_block" },
        "start": { "type": "string" },
        "end": { "type": "string" }
      },
      "additionalProperties": false
    },
    "buffer_min_rule": {
      "type": "object",
      "required": ["type", "minutes"],
      "properties": {
        "type": { "const": "buffer_min" },
        "minutes": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false
    },
    "ban_dow_time_rule": {
      "type": "object",
      "required": ["type", "day_of_week", "start", "end"],
      "properties": {
        "type": { "const": "ban_dow_time" },
        "day_of_week": { "type": "integer", "minimum": 0, "maximum": 6 },
        "start": { "type": "string" },
        "end": { "type": "string" }
      },
      "additionalProperties": false
    }
  }
}

